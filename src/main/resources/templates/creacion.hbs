{{! ============================================
    CREACI√ìN DE HECHOS
    Formulario para cargar nuevos hechos hist√≥ricos
    ============================================ }}

{{! --- Header: Navegaci√≥n del Usuario --- }}
{{#partial "contenido-header"}}
  {{#if esRegistrado}}
    <span>üë§ {{username}}</span>
    {{#if esAdmin}}
      <a href="/dashboard" class="link-primary">Panel Admin</a>
    {{/if}}
    <a href="/logout" class="link-danger">Cerrar sesi√≥n</a>
  {{else}}
    <a href="/login" class="link-primary">Iniciar sesi√≥n</a>
    <a href="/register" class="link-primary">Registrarse</a>
  {{/if}}
{{/partial}}

{{! ==========================================
    CONTENIDO PRINCIPAL
    ========================================== }}
{{#partial "contenido"}}
  <link rel="stylesheet" href="/assets/creacion.css">

  <div class="form-container">
    {{! --- T√≠tulo de la P√°gina --- }}
    <h1>{{titulo}}</h1>

    {{! --- Mensajes Flash --- }}
    {{#if flash_error}}
      <div class="flash error">{{flash_error}}</div>
    {{/if}}

    {{#if flash_message}}
      <div class="flash success">{{flash_message}}</div>
    {{/if}}

    {{! ==========================================
        FORMULARIO DE CREACI√ìN DE HECHO
        ========================================== }}
    <form action="/hechos" method="POST" enctype="multipart/form-data">

      {{! Campo: T√≠tulo del Hecho }}
      <label for="titulo">T√≠tulo</label>
      <input type="text" name="titulo" placeholder="Ej: Incendio en el centro" required>

      {{! Campo: Descripci√≥n }}
      <label for="descripcion">Descripci√≥n</label>
      <textarea name="descripcion" placeholder="Describe brevemente el hecho..." required></textarea>

      {{! Campo: Categor√≠a }}
      <label for="categoria">Categor√≠a</label>
      <input type="text" name="categoria" placeholder="Ej: Incendios, Accidentes, Contaminaci√≥n" required>

      <label>Seleccionar ubicaci√≥n en el mapa</label>
      <div id="map" style="height: 400px; margin-bottom: 20px;"></div>

      <div id="ubicacionTexto"></div>

      {{! Campo: Latitud }}
      <label for="latitud">Latitud</label>
      <input type="number" step="0.0001" name="latitud" placeholder="-34.6037" required>

      {{! Campo: Longitud }}
      <label for="longitud">Longitud</label>
      <input type="number" step="0.0001" name="longitud" placeholder="-58.3816" required>

      {{! Campo: Fecha del Acontecimiento }}
      <label for="fechaAcontecimiento">Fecha del Acontecimiento</label>
      <input type="datetime-local" name="fechaAcontecimiento" required>

      {{! Campo: Multimedia (opcional) }}
      <label for="multimedia">Contenido Multimedia (imagen o video)</label>
      <input type="file" name="multimedia" accept="image/*,video/*">

      {{! --- Vista Previa del Archivo --- }}
      <div class="preview" id="preview-container">
        <p><strong>Vista previa:</strong></p>
        <div id="preview-content"></div>
      </div>

      {{! Bot√≥n de Env√≠o }}
      <button type="submit">üìç Cargar Hecho</button>
    </form>
  </div>

  {{! ==========================================
      SCRIPT: Vista Previa de Multimedia
      ========================================== }}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>

    const input = document.querySelector('input[name="multimedia"]');
    const previewContainer = document.getElementById('preview-container');
    const previewContent = document.getElementById('preview-content');

    input.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) {
        previewContainer.style.display = 'none';
        return;
      }

      const url = URL.createObjectURL(file);
      previewContent.innerHTML = '';

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = url;
        previewContent.appendChild(img);
      } else if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = url;
        video.controls = true;
        previewContent.appendChild(video);
      }

      previewContainer.style.display = 'block';
    });
  </script>
  <script>
    // Inicializar mapa centrado en Argentina
    var map = L.map('map').setView([-34.6037, -58.3816], 6);

    // üó∫Ô∏è Mapa de calles (OpenStreetMap)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap & CartoDB'
    }).addTo(map);

    var marker;

    map.on('click', function(e) {

        var lat = e.latlng.lat;
        var lon = e.latlng.lng;

        console.log("CLICK EN:", lat, lon);

        // üî• ahora s√≠ setea los inputs correctos
        document.querySelector('input[name="latitud"]').value = lat;
        document.querySelector('input[name="longitud"]').value = lon;

        if (marker) {
            map.removeLayer(marker);
        }

        marker = L.marker([lat, lon]).addTo(map);

        fetch(`/api/ubicacion?lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("ubicacionTexto").innerText =
                    "Provincia: " + data.provincia +
                    " | Municipio: " + data.municipio;
            });
    });
  </script>
{{/partial}}

{{> templates/layout}}

